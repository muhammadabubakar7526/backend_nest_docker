name: Docker Build & Deploy Backend

# Trigger workflow on push to main or prod branch
on:
  push:
    branches:
      - main
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up SSH to your server
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Starting backend deployment..."

            # Navigate to backend folder on server
            cd /home/user/auth-project

            # Pull latest Docker image if using Docker Hub (optional)
            # docker pull your-dockerhub-username/auth-backend:latest || true

            # Build new Docker image
            docker build -t auth-backend .

            # Stop old container if running
            docker stop auth-backend-container || true

            # Remove old container if exists
            docker rm auth-backend-container || true

            # Run new container
            docker run -d -p 3000:3000 --name auth-backend-container --env-file .env auth-backend

            echo "Backend deployed successfully!"
